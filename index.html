<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Notas - Pinceladas Montessori</title>
    
    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect x=%2210%22 y=%2240%22 width=%2220%22 height=%2250%22 rx=%224%22 fill=%22%23002060%22/><rect x=%2240%22 y=%2225%22 width=%2220%22 height=%2265%22 rx=%224%22 fill=%22%23002060%22/><rect x=%2270%22 y=%2210%22 width=%2220%22 height=%2280%22 rx=%224%22 fill=%22%23C00000%22/></svg>">

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Chewy&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        montserrat: ['Montserrat', 'sans-serif'],
                        chewy: ['Chewy', 'cursive']
                    },
                    colors: {
                        montessori: {
                            blue: '#002060',
                            red: '#C00000',
                            yellow: '#FFD966',
                            gray: '#F3F4F6'
                        },
                        logo: {
                            blue: '#002060',
                            red: '#C00000'
                        }
                    },
                    boxShadow: {
                        'card-hover': '0 15px 30px -5px rgba(0, 0, 0, 0.08), 0 10px 12px -6px rgba(0, 0, 0, 0.02)',
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.03)', 
                    },
                    animation: {
                        'blob': 'blob 20s infinite alternate',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(80px, -100px) scale(1.2) rotate(20deg)' },
                            '66%': { transform: 'translate(-60px, 60px) scale(0.9) rotate(-10deg)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* --- CORE LAYOUT & PERFORMANCE --- */
        body { 
            background-color: #ffffff; 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        .animate-blob, .transition-all, .transform, .marquee-content {
            will-change: transform, opacity;
            transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        main {
            flex: 1;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            padding: 1.5rem; 
            width: 100%;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- MARQUEE --- */
        .marquee-wrapper {
            display: flex;
            overflow: hidden;
            user-select: none;
            mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
            align-items: center; 
        }

        .marquee-content {
            flex-shrink: 0;
            display: flex;
            align-items: center; 
            justify-content: space-around;
            min-width: 100%;
            gap: 0; 
            animation: scroll-seamless 50s linear infinite;
            height: 100%; 
        }

        @keyframes scroll-seamless {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }

        /* --- ANIMACIONES GENERALES --- */
        @keyframes colorPulse { 
            0% { color: #9CA3AF; } 
            25% { color: #C00000; } 
            50% { color: #9CA3AF; } 
            75% { color: #002060; } 
            100% { color: #9CA3AF; } 
        }
        .animate-pulse-color { animation: colorPulse 8s ease-in-out infinite; }

        @keyframes blueRedCycle {
            0%, 100% { color: #002060; } 
            50% { color: #C00000; }      
        }
        .animate-blue-red { animation: blueRedCycle 3s infinite cubic-bezier(0.4, 0, 0.2, 1); }


        /* Loader */
        .loader {
            border: 3px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top: 3px solid #ffffff;
            width: 20px; 
            height: 20px; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Transiciones */
        .fade-out { animation: fadeOut 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .fade-in { animation: fadeIn 0.7s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        
        @keyframes fadeOut { 
            from { opacity: 1; transform: scale(1); filter: blur(0); } 
            to { opacity: 0; transform: scale(0.98); filter: blur(4px); pointer-events: none; } 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: scale(0.98); filter: blur(4px); } 
            to { opacity: 1; transform: scale(1); filter: blur(0); } 
        }

        /* --- LOGO --- */
        :root { --logo-blue: #002060; --logo-red: #C00000; }
        
        .text-colegio {
            color: var(--logo-blue);
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: -0.1em;
            line-height: 1;
        }
        .text-pinceladas {
            font-family: 'Chewy', cursive;
            color: var(--logo-red);
            line-height: 1;
        }
        .text-montessori-sub {
            background-color: var(--logo-blue);
            color: #ffffff;
            padding: 0.1em 0.3em;
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: -0.1em;
            letter-spacing: 0.1em;
            text-align: center;
            width: auto; 
        }
        
        .logo-lg .text-colegio { font-size: clamp(1rem, 2.5vw, 1.2rem); }
        .logo-lg .text-pinceladas { font-size: clamp(2.5rem, 6vw, 3.2rem); }
        .logo-lg .text-montessori-sub { font-size: clamp(1rem, 2.5vw, 1.2rem); }

        .logo-sm .text-colegio { font-size: 0.55rem; }
        .logo-sm .text-pinceladas { font-size: 1.3rem; }
        .logo-sm .text-montessori-sub { font-size: 0.55rem; padding: 1px 4px; }

        /* --- FONDO ACADÉMICO Y PARTÍCULAS --- */
        
        .particles-container {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .grade-particle {
            position: absolute;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900; 
            opacity: 0;
            user-select: none;
            text-shadow: 0 2px 4px rgba(255,255,255,0.5); 
        }

        /* Colores definidos - Alta visibilidad */
        .grade-particle.blue { color: rgba(0, 32, 96, 0.25); }
        .grade-particle.red { color: rgba(192, 0, 0, 0.25); }

        /* Animación Fondo */
        .grade-particle.background {
            animation: floatUp linear infinite;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(110vh) scale(0.8) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% {
                transform: translateY(-10vh) scale(1.1) rotate(var(--rotation));
                opacity: 0;
            }
        }

        /* Patrón de cuadrícula sutil */
        .grid-overlay {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(0, 32, 96, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 32, 96, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 0;
        }
    </style>
</head>
<body class="text-slate-800 font-sans antialiased">

    <!-- ================================ -->
    <!-- PANTALLA DE CARGA INICIAL (PRELOADER) -->
    <!-- ================================ -->
    <!-- z-300 -->
    <div id="initial-loader" class="fixed inset-0 z-[300] flex items-center justify-center bg-white transition-all duration-700">
        <!-- Blobs de Fondo (z-0 relativo a este padre) -->
        <div class="absolute inset-0 w-full h-full overflow-hidden z-0">
            <div class="absolute top-[-10%] left-[-10%] w-[45rem] h-[45rem] bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[0ms]"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[38rem] h-[38rem] bg-red-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[3000ms]"></div>
            <div class="absolute top-[30%] left-[30%] w-[32rem] h-[32rem] bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[6000ms]"></div>
        </div>
        
        <!-- PARTICULAS ACADÉMICAS (z-10: Encima de blobs, debajo del texto) -->
        <div class="particles-container z-10">
            <div class="grid-overlay"></div>
            <!-- JS inyectará partículas aquí -->
        </div>

        <!-- CONTENIDO (z-20: Encima de todo) -->
        <div class="relative z-20 flex flex-col items-center justify-center">
            <h1 class="text-5xl md:text-7xl font-bold font-montserrat animate-blue-red drop-shadow-sm text-center leading-tight">
                Cargando...
            </h1>
        </div>
    </div>

    <!-- ================================ -->
    <!-- PANTALLA DE LOGIN -->
    <!-- ================================ -->
    <!-- z-100 -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-50 overflow-hidden transition-all duration-700">
        <!-- Blobs de Fondo (z-0) -->
        <div class="absolute inset-0 w-full h-full overflow-hidden z-0">
            <div class="absolute top-[-10%] left-[-10%] w-[45rem] h-[45rem] bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[0ms]"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[38rem] h-[38rem] bg-red-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[3000ms]"></div>
            <div class="absolute top-[30%] left-[30%] w-[32rem] h-[32rem] bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[6000ms]"></div>
        </div>

        <!-- PARTICULAS ACADÉMICAS (z-10: Debajo de la tarjeta de login que es z-20) -->
        <div class="particles-container z-10">
            <div class="grid-overlay"></div>
            <!-- JS inyectará partículas aquí -->
        </div>

        <!-- Tarjeta y contenido (z-20 y superior) -->
        <div id="quote-container" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center p-8 text-center max-w-4xl mx-auto">
            <h2 id="quote-text" class="text-3xl md:text-5xl font-bold text-montessori-blue leading-tight font-montessori drop-shadow-sm mb-4"></h2>
            <div class="h-1 w-24 bg-montessori-red rounded-full mx-auto"></div>
        </div>

        <div id="login-card" class="relative z-20 w-full max-w-3xl mx-4 transition-all duration-700">
            <div class="bg-white/90 backdrop-blur-xl border border-white/50 rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[380px]">
                <div class="w-full md:w-5/12 bg-gray-50/80 flex flex-col items-center justify-center p-6 border-b md:border-b-0 md:border-r border-gray-100 gap-4">
                    <div class="logo-container logo-lg cursor-default text-center transform scale-90 md:scale-100">
                        <div class="text-section flex flex-col items-center">
                            <div class="text-colegio">COLEGIO</div>
                            <div class="text-pinceladas">Pinceladas</div>
                            <div class="text-montessori-sub">MONTESSORI</div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 font-medium text-center hidden md:block mt-2">Sistema de Gestión Académica</p>
                </div>

                <div class="w-full md:w-7/12 p-6 md:p-8 flex flex-col justify-center">
                    <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5">Credenciales de Acceso</label>
                            <div class="space-y-3">
                                <div class="relative group z-20">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-400 group-focus-within:text-montessori-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    </div>
                                    <input type="text" id="username" required class="w-full pl-10 pr-4 py-2.5 rounded-lg bg-white border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-500 text-sm placeholder-gray-400" placeholder="Usuario">
                                </div>
                                <div class="relative group z-20">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-400 group-focus-within:text-montessori-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                    </div>
                                    <input type="password" id="password" required class="w-full pl-10 pr-4 py-2.5 rounded-lg bg-white border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-500 text-sm placeholder-gray-400" placeholder="Contraseña">
                                </div>
                            </div>
                        </div>
                        
                        <div id="login-status-container" class="min-h-[40px] transition-all duration-300 rounded-lg flex items-center justify-center gap-2 border border-transparent text-center px-2 py-1 bg-gray-50">
                             <span id="login-status-text" class="text-xs font-medium text-gray-400">Ingrese sus credenciales para continuar</span>
                        </div>
                        
                        <button type="submit" id="btn-login" class="relative w-full bg-montessori-blue text-white font-bold text-sm py-3 rounded-lg shadow-lg shadow-montessori-blue/30 hover:bg-montessori-blue hover:shadow-montessori-blue/50 hover:scale-[1.01] active:scale-[0.99] transition-all duration-300 flex justify-center items-center">
                            <span id="btn-text">Iniciar Sesión</span>
                            <div id="btn-loader" class="loader hidden absolute w-5 h-5 border-2"></div>
                        </button>
                    </form>
                    <div class="mt-4 text-center">
                        <a href="https://mail.google.com/mail/?view=cm&fs=1&to=gestion.educativa.pinceladas@gmail.com" target="_blank" class="text-[10px] text-gray-400 hover:text-montessori-blue transition-colors font-medium inline-flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            Soporte Técnico
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================ -->
    <!-- PANTALLA DE TIMEOUT (OPTIMIZADA) -->
    <!-- ================================ -->
    <!-- z-200 -->
    <div id="timeout-screen" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-gray-50 overflow-hidden opacity-0 transition-opacity duration-500 ease-out">
        <!-- Blobs de Fondo (z-0) -->
        <div class="absolute inset-0 w-full h-full overflow-hidden z-0">
            <div class="absolute top-[-10%] left-[-10%] w-[45rem] h-[45rem] bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[0ms]"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[38rem] h-[38rem] bg-red-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[3000ms]"></div>
            <div class="absolute top-[30%] left-[30%] w-[32rem] h-[32rem] bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[6000ms]"></div>
        </div>

        <!-- PARTICULAS ACADÉMICAS (z-10) -->
        <div class="particles-container z-10">
            <div class="grid-overlay"></div>
            <!-- JS inyectará partículas aquí -->
        </div>
        
        <!-- Contenido modal (z-20) -->
        <div class="relative z-20 bg-white/90 backdrop-blur-md p-8 rounded-3xl shadow-2xl border border-white/50 max-w-lg w-full text-center transform transition-transform duration-500 scale-95" id="timeout-content">
            <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6 ring-4 ring-red-50/50">
                <svg class="w-10 h-10 text-montessori-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2" id="timeout-title">Sesión Finalizada por Seguridad</h3>
            <p class="text-gray-500 text-sm mb-8 leading-relaxed" id="timeout-message">Para proteger la confidencialidad de la información académica, la sesión ha finalizado tras detectar un periodo de inactividad. Presione el botón para restablecer el acceso.</p>
            <button onclick="location.reload()" class="w-full bg-montessori-blue text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-blue-800 hover:shadow-montessori-blue/30 transition-all duration-300 transform hover:-translate-y-0.5 active:translate-y-0">
                Restablecer Sesión
            </button>
        </div>
    </div>

    <!-- ================================ -->
    <!-- MODAL ACCESO DENEGADO (POP-UP) -->
    <!-- ================================ -->
    <div id="access-denied-modal" class="hidden fixed inset-0 z-[210] flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full mx-4 transform scale-95 transition-transform duration-300 border border-gray-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-50 mb-4 animate-pulse">
                    <svg class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h3 class="text-xl leading-6 font-bold text-gray-900 mb-2" id="modal-title">Acceso Restringido por Permisos</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500 mb-6" id="access-denied-message">El acceso a este **curso** ha sido denegado. El perfil de usuario actual no tiene asignados los permisos necesarios para visualizar la información de este grado. Para asistencia o revisión de permisos, contacte al **Tío Christopher**.</p>
                </div>
                <div class="mt-2">
                    <button type="button" onclick="closeAccessDenied()" class="w-full inline-flex justify-center items-center rounded-xl border border-transparent shadow-md px-4 py-3 bg-gray-800 text-base font-bold text-white hover:bg-gray-700 focus:outline-none transition-all transform hover:-translate-y-0.5">
                        Aceptar y Continuar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================ -->
    <!-- APLICACIÓN PRINCIPAL -->
    <!-- ================================ -->
    <!-- z-0: Base del app -->
    <div id="app-content" class="hidden flex-col h-full w-full relative z-0 opacity-0 transition-opacity duration-1000 overflow-hidden">
        
        <!-- FONDO ACADÉMICO INYECTADO (z-0: Fondo base) -->
        <div id="academic-background" class="particles-container z-0">
            <div class="grid-overlay"></div>
            <!-- JS inyectará partículas aquí -->
        </div>

        <!-- HEADER (z-50) -->
        <header class="bg-white/90 backdrop-blur-sm border-b border-gray-100 sticky top-0 z-50 h-14 flex-shrink-0 w-full">
            <div class="w-full px-6 h-full flex justify-between items-center">
                <!-- LOGO NO CLICKEABLE -->
                <div class="logo-container logo-sm select-none">
                    <div class="text-section flex flex-col items-center">
                        <div class="text-colegio">COLEGIO</div>
                        <div class="text-pinceladas">Pinceladas</div>
                            <div class="text-montessori-sub">MONTESSORI</div>
                    </div>
                </div>
                <!-- HEADER PERSONALIZADO -->
                <div class="flex items-center h-full">
                    <!-- Info Usuario -->
                    <div class="flex flex-col items-end mr-4">
                        <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest leading-tight">Conectado como</span>
                        <span id="user-name-display" class="text-sm font-black text-montessori-blue leading-tight">...</span>
                    </div>

                    <!-- Separador Vertical -->
                    <div class="h-6 w-px bg-gray-200 mx-1"></div>

                    <!-- Botón Salir -->
                    <button onclick="logout()" class="ml-4 bg-red-50 hover:bg-red-100 text-red-500 font-bold text-xs px-3 py-1.5 rounded transition-all duration-200 flex items-center gap-2 group border border-transparent hover:border-red-200 uppercase tracking-wide">
                        <span>Cerrar Sesión</span>
                        <svg class="w-3 h-3 transform group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN (z-10: Encima del fondo, pero debajo del header) -->
        <main class="flex-1 w-full px-6 py-6 no-scrollbar overflow-y-auto bg-transparent relative z-10">
            
            <div class="w-full">
                
                <!-- DASHBOARD METRICS -->
                <div id="dashboard-metrics" class="max-w-[1440px] mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 fade-in">
                    
                    <!-- CARD 1 -->
                    <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-soft flex items-center gap-5 hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <div class="h-14 w-14 flex-shrink-0 rounded-[1.2rem] bg-blue-50 text-blue-600 flex items-center justify-center">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                        <div class="flex flex-col justify-center">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">Límite Calificaciones</p>
                            <p class="text-xl font-bold text-slate-800 leading-none">15 de Diciembre de 2025</p>
                        </div>
                    </div>

                    <!-- CARD 2 -->
                    <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-soft flex items-center gap-5 hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                         <div class="h-14 w-14 flex-shrink-0 rounded-[1.2rem] bg-montessori-red/10 text-montessori-red flex items-center justify-center">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <div class="flex flex-col justify-center">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">Entrega de Boletines</p>
                            <p class="text-xl font-bold text-slate-800 leading-none">06 de Febrero de 2026</p>
                        </div>
                    </div>

                    <!-- CARD 3 -->
                    <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-soft flex items-center gap-5 hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <div id="status-icon-bg" class="h-14 w-14 flex-shrink-0 rounded-[1.2rem] bg-purple-50 text-purple-600 flex items-center justify-center transition-colors">
                             <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                        </div>
                        <div class="flex flex-col justify-center">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">Base de Datos</p>
                            <div class="flex items-center gap-2.5">
                                <span id="status-dot" class="w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse"></span>
                                <span id="status-label" class="text-2xl font-bold text-slate-800 leading-none">...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA HOME: LISTADO GRADOS -->
                <div id="view-home" class="max-w-[1440px] mx-auto fade-in h-full flex flex-col pb-8 w-full">
                    
                    <!-- Primaria -->
                    <div class="flex items-center gap-3 mb-4 pb-1">
                        <div class="h-6 w-1.5 bg-montessori-red rounded-full"></div>
                        <h2 class="text-lg font-bold text-montessori-red">Nivel Primaria</h2>
                    </div>
                    <div id="grid-primaria" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8"></div>

                    <!-- Secundaria -->
                    <div class="flex items-center gap-3 mb-4 pb-1">
                        <div class="h-6 w-1.5 bg-montessori-blue rounded-full"></div>
                        <h2 class="text-lg font-bold text-montessori-blue">Nivel Secundaria</h2>
                    </div>
                    <div id="grid-secundaria" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

                    <!-- BANNER DE ANUNCIOS -->
                    <div id="announcement-banner" class="hidden mt-8 rounded-xl overflow-hidden shadow-sm border border-montessori-red fade-in relative bg-white w-full">
                        <div class="flex items-center relative h-12">
                            <div class="absolute left-0 top-0 h-full z-20 bg-white pr-4 pl-4 flex items-center gap-2 border-r border-montessori-red shadow-[2px_0_5px_rgba(0,0,0,0.05)]">
                                <div class="bg-montessori-red/10 p-1.5 rounded-full animate-pulse">
                                    <svg class="w-4 h-4 text-montessori-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-bold tracking-widest uppercase text-montessori-red">Avisos</span>
                            </div>
                            <div class="marquee-wrapper w-full h-full pl-[110px]"> 
                                <div id="marquee-track" class="marquee-content font-bold text-sm text-montessori-blue"></div>
                                <div id="marquee-track-clone" class="marquee-content font-bold text-sm text-montessori-blue" aria-hidden="true"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA ESTUDIANTES -->
                <div id="view-students" class="hidden fade-in w-full">
                    <div class="w-full"> 
                        <div class="flex items-center gap-2 mb-6 text-sm text-gray-500">
                            <button onclick="showHome()" class="hover:text-montessori-blue hover:underline flex items-center gap-1 font-medium transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                Volver a Grados
                            </button>
                            <span>/</span>
                            <span id="current-grade-title" class="font-bold text-montessori-blue">...</span>
                        </div>
                        
                        <div class="w-full">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-gray-700 text-lg">Listado Oficial</h3>
                                <div id="loading-indicator" class="hidden flex items-center gap-2 text-montessori-blue">
                                     <div class="loader" style="width: 16px; height: 16px; border-width: 2px; border-color: #E5E7EB; border-top-color: #002060;"></div>
                                     <span class="text-xs font-medium">Actualizando...</span>
                                </div>
                            </div>
                            <div id="students-list-container" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="bg-white/90 backdrop-blur-sm border-t border-gray-200 py-6 mt-auto flex-shrink-0 w-full z-10">
            <div class="text-center text-[10px] sm:text-xs text-gray-400">
                <a href="https://chrisjocoes21.github.io/PORTAFOLIO/" target="_blank" class="animate-pulse-color font-medium transition-colors hover:text-montessori-blue hover:underline" title="Visitar Portafolio">
                    © 2025 Sistema de Calificaciones - Desarrollado por Didac-Click Group.
                </a>
            </div>
        </footer>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwnNusWP5LlxipynwTszW7bz70GNZa4n3RfEm-8tsM7nFktVeNvXATqz8HddKY_2YK9/exec"; 
        
        const loginScreen = document.getElementById('login-screen');
        const loginCard = document.getElementById('login-card');
        const quoteContainer = document.getElementById('quote-container');
        const quoteText = document.getElementById('quote-text');
        const appContent = document.getElementById('app-content');
        const userNameDisplay = document.getElementById('user-name-display');
        const loginStatusContainer = document.getElementById('login-status-container');
        const loginStatusText = document.getElementById('login-status-text');
        const btnLogin = document.getElementById('btn-login');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const timeoutScreen = document.getElementById('timeout-screen');
        const accessDeniedModal = document.getElementById('access-denied-modal');
        const accessDeniedTitle = document.getElementById('modal-title'); 
        const accessDeniedMessage = document.getElementById('access-denied-message'); 
        const accessDeniedButton = accessDeniedModal.querySelector('button'); 
        const initialLoader = document.getElementById('initial-loader');

        let userPermissions = '';

        function initDynamicTexts(name) {
            if (name) {
                userNameDisplay.textContent = name;
            }

            accessDeniedTitle.textContent = 'Acceso Restringido por Permisos';
            accessDeniedMessage.textContent = 'El acceso a este curso ha sido denegado. El perfil de usuario actual no tiene asignados los permisos necesarios para visualizar la información de este grado. Para asistencia o revisión de permisos, contacte al Tío Christopher.';
            accessDeniedButton.textContent = 'Aceptar y Continuar';

            document.getElementById('timeout-title').textContent = 'Sesión Finalizada por Seguridad';
            document.getElementById('timeout-message').textContent = 'Para proteger la confidencialidad de la información académica, la sesión ha finalizado tras detectar un periodo de inactividad. Presione el botón para restablecer el acceso.';
            document.querySelector('#timeout-content button').textContent = 'Restablecer Sesión';
        }


        const quotes = [
            "Lo más importante es que lo más importante sea lo más importante.",
            "Empieza cada día con un fin en mente.",
            "Busca primero entender, para luego ser entendido.",
            "La mejor forma de predecir tu futuro es creándolo.",
            "Sinergiza: El todo es más grande que la suma de sus partes.",
            "Sé proactivo: Tú eres el arquitecto de tu destino.",
            "Afila la sierra: Nunca dejes de aprender y crecer."
        ];

        const gradosPrimaria = [
            { nombre: "1º Grado", nivel: "Primaria", icon: "1" },
            { nombre: "2º Grado", nivel: "Primaria", icon: "2" },
            { nombre: "3º Grado", nivel: "Primaria", icon: "3" },
            { nombre: "4º Grado", nivel: "Primaria", icon: "4" },
            { nombre: "5º Grado", nivel: "Primaria", icon: "5" },
            { nombre: "6º Grado", nivel: "Primaria", icon: "6" }
        ];

        const gradosSecundaria = [
            { nombre: "1º Grado", nivel: "Secundaria", icon: "I" },
            { nombre: "2º Grado", nivel: "Secundaria", icon: "II" },
            { nombre: "3º Grado", nivel: "Secundaria", icon: "III" }
        ];

        const gradePromises = {}; 
        let inactivityTimer;
        let currentUserTimeoutMs = 1.5 * 60 * 1000; 
        let statusInterval; 

        const matchWidths = () => {
            try {
                document.querySelectorAll('.logo-container').forEach(container => {
                    const pinceladas = container.querySelector('.text-pinceladas');
                    const montessori = container.querySelector('.text-montessori-sub');
                    if (pinceladas && montessori) {
                        montessori.style.width = `${pinceladas.offsetWidth}px`;
                    }
                });
            } catch (error) { console.error(error); }
        };
        window.addEventListener('resize', matchWidths);

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            if (loginScreen.classList.contains('hidden') && 
                timeoutScreen.classList.contains('hidden')) { 
                
                inactivityTimer = setTimeout(() => {
                    handleSessionTimeout();
                }, currentUserTimeoutMs);
            }
        }

        function handleSessionTimeout() {
            sessionStorage.removeItem('pinceladas_session');
            
            timeoutScreen.classList.remove('hidden');
            requestAnimationFrame(() => {
                 document.getElementById('timeout-content').classList.remove('scale-95');
                 document.getElementById('timeout-content').classList.add('scale-100');
                 timeoutScreen.classList.remove('opacity-0');
            });
            appContent.classList.add('blur-sm');
        }
        
        function removeInitialLoader() {
            if(!initialLoader) return;
            initialLoader.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                initialLoader.classList.add('hidden');
            }, 700);
        }

        window.onload = () => {
            // Se elimina la lógica de 'handleMouseMove' para optimizar rendimiento
            document.body.onmousemove = resetInactivityTimer;
            document.body.onkeydown = resetInactivityTimer;
            document.body.onclick = resetInactivityTimer;
            matchWidths();
            setTimeout(() => {
                 checkSessionValidity();
            }, 800);
            
            checkSystemStatus(); 
            initDynamicTexts();
            initAllParticles(); // Inicializar fondos animados en todas las pantallas
        };

        function checkSessionValidity() {
            const sessionData = sessionStorage.getItem('pinceladas_session');
            if (sessionData) {
                const session = JSON.parse(sessionData);
                const sessionTimeout = session.timeout ? (session.timeout * 60 * 1000) : currentUserTimeoutMs;
                
                if ((new Date().getTime() - session.loginTime) > sessionTimeout) {
                    sessionStorage.removeItem('pinceladas_session');
                    removeInitialLoader();
                } else {
                    currentUserTimeoutMs = sessionTimeout;
                    userPermissions = session.permissions || ''; 
                    skipIntro(session.name);
                    resetInactivityTimer();
                }
            } else {
                removeInitialLoader();
            }
        }

        function updateLoginStatus(status, message) {
            loginStatusContainer.className = 'min-h-[40px] transition-all duration-300 rounded-lg flex items-center justify-center gap-2 border px-2 py-1';
            loginStatusText.className = 'text-xs font-bold';
            loginStatusText.textContent = message;
            
            if (status === 'error') {
                loginStatusContainer.classList.add('bg-red-50', 'border-red-200');
                loginStatusText.classList.add('text-red-600');
            } else if (status === 'success') {
                loginStatusContainer.classList.add('bg-green-50', 'border-green-200');
                loginStatusText.classList.add('text-green-600');
            } else if (status === 'loading') {
                loginStatusContainer.classList.add('bg-blue-50', 'border-blue-200');
                loginStatusText.classList.add('text-blue-600');
            } else {
                 loginStatusContainer.classList.add('bg-gray-50', 'border-transparent');
                 loginStatusText.classList.add('text-gray-400', 'font-medium');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value;
            
            updateLoginStatus('loading', 'Verificando credenciales...');
            btnText.classList.add('opacity-0');
            btnLoader.classList.remove('hidden');
            btnLogin.classList.add('cursor-not-allowed');
            btnLogin.disabled = true;

            try {
                // Agregamos redirect: 'follow' para mayor robustez con GAS
                const response = await fetch(`${API_URL}?action=login&username=${encodeURIComponent(usernameInput)}&password=${encodeURIComponent(passwordInput)}`, {
                    redirect: "follow"
                });
                
                if (!response.ok) throw new Error("Network response was not ok");

                const data = await response.json();
                
                if (data.success) {
                    updateLoginStatus('success', '¡Acceso Autorizado! Redirigiendo...');
                    currentUserTimeoutMs = (data.timeout || 1.5) * 60 * 1000;
                    userPermissions = data.permissions || ''; 
                    
                    sessionStorage.setItem('pinceladas_session', JSON.stringify({
                        auth: true,
                        name: data.name,
                        permissions: data.permissions, 
                        timeout: data.timeout,
                        loginTime: new Date().getTime()
                    }));
                    
                    // ESCALONAR PETICIONES:
                    // No llamar a todo al mismo tiempo para evitar errores de "Failed to fetch" (bloqueo temporal por muchas peticiones)
                    setTimeout(() => checkSystemStatus(data.name), 100); 
                    setTimeout(() => prefetchGradesData(), 300);
                    setTimeout(() => loadAnnouncements(), 800); 

                    setTimeout(() => {
                        unlockInterface(data.name);
                    }, 1000);
                } else {
                    throw new Error('Credenciales'); // Error específico de lógica
                }
            } catch (error) {
                // Distinguir entre error de red y credenciales
                if (error.message === 'Credenciales') {
                    updateLoginStatus('error', 'Credenciales incorrectas');
                } else {
                    console.warn("Login fetch error:", error);
                    updateLoginStatus('error', 'Error de conexión. Intente de nuevo.');
                }

                btnText.classList.remove('opacity-0');
                btnLoader.classList.add('hidden');
                btnLogin.classList.remove('cursor-not-allowed');
                btnLogin.disabled = false;
                if (navigator.vibrate) navigator.vibrate(200);
            } finally {
                document.getElementById('password').value = '';
            }
        }

        function checkPermissions(gradeName, level) {
            const sessionData = sessionStorage.getItem('pinceladas_session');
            if (!sessionData) return false;
            
            const session = JSON.parse(sessionData);
            const userPerms = (session.permissions || "").toUpperCase().trim();
            
            if (userPerms === 'TODO' || userPerms === 'ADMIN') return true;

            const g = gradeName.toUpperCase(); 
            const l = (level || "").toUpperCase();     

            if (userPerms.includes(`${g} ${l}`)) return true; 
            
            const shortGrade = g.replace(' GRADO', ''); 
            if (userPerms.includes(`${shortGrade} ${l}`)) return true;

            if (userPerms.includes(g)) return true;

            return false;
        }

        function closeAccessDenied() {
            accessDeniedModal.classList.remove('opacity-100');
            accessDeniedModal.classList.add('opacity-0');
            setTimeout(() => {
                accessDeniedModal.classList.add('hidden');
            }, 300);
        }

        function prefetchGradesData() {
            const allGrades = [...gradosPrimaria, ...gradosSecundaria];
            allGrades.forEach(g => {
                if (checkPermissions(g.nombre, g.nivel)) {
                    const key = `${g.nombre}-${g.nivel}`;
                    gradePromises[key] = fetch(`${API_URL}?action=getStudents&grade=${encodeURIComponent(g.nombre)}&level=${encodeURIComponent(g.nivel)}&t=${new Date().getTime()}`, { redirect: 'follow' })
                        .then(response => response.json())
                        .catch(error => []);
                }
            });
        }

        function skipIntro(name) {
            prefetchGradesData(); 
            loginScreen.classList.add('hidden');
            appContent.classList.remove('hidden');
            appContent.classList.add('flex', 'fade-in');
            initApp(name);
            removeInitialLoader();
        }

        function unlockInterface(name) {
            loginCard.classList.add('fade-out');
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            quoteText.textContent = randomQuote;

            setTimeout(() => {
                loginCard.classList.add('hidden'); 
                quoteContainer.classList.remove('hidden');
                quoteContainer.classList.add('fade-in');
            }, 400);

            setTimeout(() => {
                loginScreen.classList.add('fade-out');
                setTimeout(() => {
                    loginScreen.classList.add('hidden');
                    quoteContainer.classList.add('hidden'); 
                    appContent.classList.remove('hidden');
                    appContent.classList.add('flex', 'fade-in');
                    initApp(name);
                }, 500); 
            }, 4000); 
        }

        function initApp(name) {
            userNameDisplay.textContent = name || 'Usuario';
            renderGrades();
            startStatusCycle(name);
            loadAnnouncements();
            resetInactivityTimer(); 
            setTimeout(matchWidths, 100); 
        }
        
        function startStatusCycle(username) {
            checkSystemStatus(username);
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(() => {
                if (!document.hidden) {
                    checkSystemStatus(username);
                }
            }, 60000); 
        }

        async function checkSystemStatus(username = null) {
            const dot = document.getElementById('status-dot');
            const label = document.getElementById('status-label');
            const iconBg = document.getElementById('status-icon-bg');
            
            if (!dot || !label || !iconBg) {
                console.error("Dashboard elements not fully loaded. Skipping status check.");
                return; 
            }
            
            let url = `${API_URL}?action=checkStatus&t=${new Date().getTime()}`;
            if (username) url += `&username=${encodeURIComponent(username)}`;

            try {
                const response = await fetch(url, { redirect: 'follow' });
                if (response.ok) {
                    const data = await response.json();
                    
                    if(data.status === 'online') {
                        dot.classList.remove('bg-gray-400', 'bg-red-500'); dot.classList.add('bg-green-500');
                        label.textContent = "En Línea"; label.classList.add('text-green-700');
                        iconBg.classList.remove('bg-gray-100', 'text-gray-400', 'bg-purple-50', 'text-purple-600');
                        iconBg.classList.add('bg-green-50', 'text-green-600');
                    }
                }
            } catch (error) { 
                dot.classList.add('bg-red-500'); 
                label.textContent = "Offline";
                iconBg.classList.add('bg-red-50', 'text-red-600');
            } 
        }

        async function loadAnnouncements() {
            const banner = document.getElementById('announcement-banner');
            const track1 = document.getElementById('marquee-track');
            const track2 = document.getElementById('marquee-track-clone');
            
            try {
                // Redirect follow es importante para GAS
                const response = await fetch(`${API_URL}?action=getAnnouncements`, { redirect: "follow" });
                
                if (!response.ok) throw new Error('Error de red al cargar anuncios');

                const announcements = await response.json();
                
                if (announcements && announcements.length > 0) {
                    const rawText = announcements.map(a => `<span>${a.mensaje}</span>`).join('<span class="mx-6 text-montessori-red/50 text-lg font-light">|</span>');
                    if(!rawText.trim()) { banner.classList.add('hidden'); return; }

                    const separator = '<span class="mx-6 text-montessori-red/50 text-lg font-light">|</span>';
                    const repeatedBlock = `${rawText} ${separator} ${rawText} ${separator} ${rawText} ${separator}`;

                    track1.innerHTML = repeatedBlock;
                    track2.innerHTML = repeatedBlock; 
                    banner.classList.remove('hidden'); 
                } else {
                    banner.classList.add('hidden'); 
                }
            } catch (e) {
                // Usar warn en lugar de error para no alarmar en consola si falla la red
                console.warn("No se pudieron cargar los anuncios (posible bloqueo de red):", e.message);
                banner.classList.add('hidden');
            }
        }

        function logout() {
            sessionStorage.removeItem('pinceladas_session');
            location.reload();
        }

        function renderGrades() {
            const pContainer = document.getElementById('grid-primaria');
            const sContainer = document.getElementById('grid-secundaria');
            if(!pContainer || !sContainer) return; 

            const createCard = (g, colorClass, borderClass) => {
                const hasPermission = checkPermissions(g.nombre, g.nivel);
                
                const baseClasses = "cursor-pointer bg-white border rounded-xl p-6 flex justify-between items-center transition-all duration-300 group transform will-change-transform";
                let finalClasses = baseClasses;
                let finalAction = `onclick="loadStudents('${g.nombre}', '${g.nivel}')"`;
                
                let iconClasses = `h-10 w-10 rounded-lg flex items-center justify-center font-bold text-lg transition-colors`;
                let gradeClasses = `text-xl font-bold transition-colors`;
                
                if (hasPermission) {
                    finalClasses += ` ${borderClass} hover:shadow-lg hover:-translate-y-1`;
                    gradeClasses += ` text-gray-800 group-hover:text-black`;
                    
                    if (colorClass === 'red') {
                        iconClasses += ' bg-red-50 text-montessori-red';
                    } else {
                        iconClasses += ' bg-blue-50 text-montessori-blue';
                    }
                } else {
                    finalClasses += ` border-gray-100 opacity-50 cursor-not-allowed hover:shadow-none`;
                    gradeClasses += ` text-gray-400`;
                    iconClasses += ' bg-gray-50 text-gray-400';
                    finalAction = `onclick="showAccessDeniedMessage()"`;
                }

                return `
                    <div ${finalAction} class="${finalClasses}">
                         <div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Grado</p>
                            <h3 class="${gradeClasses}">${g.nombre}</h3>
                         </div>
                         <div class="${iconClasses}">
                            ${g.icon}
                         </div>
                    </div>
                `;
            };
            
            pContainer.innerHTML = gradosPrimaria.map(g => createCard(g, 'red', 'border-montessori-red')).join('');
            sContainer.innerHTML = gradosSecundaria.map(g => createCard(g, 'blue', 'border-montessori-blue')).join('');
        }
        
        function showAccessDeniedMessage() {
            initDynamicTexts();

            accessDeniedModal.classList.remove('hidden');
            setTimeout(() => {
                accessDeniedModal.classList.remove('opacity-0', 'scale-95');
                accessDeniedModal.classList.add('opacity-100', 'scale-100');
            }, 10);
        }

        function showHome() {
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('dashboard-metrics').classList.remove('hidden');
            document.getElementById('view-students').classList.add('hidden');
        }

        async function loadStudents(grade, level) {
            if (!checkPermissions(grade, level)) {
                showAccessDeniedMessage();
                return; 
            }

            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('dashboard-metrics').classList.add('hidden');
            document.getElementById('view-students').classList.remove('hidden');
            
            const titleEl = document.getElementById('current-grade-title');
            titleEl.textContent = `${grade} - ${level}`;
            titleEl.className = `font-bold ${level === 'Primaria' ? 'text-montessori-red' : 'text-montessori-blue'}`;

            const listContainer = document.getElementById('students-list-container');
            const loader = document.getElementById('loading-indicator');
            listContainer.innerHTML = '';
            loader.classList.remove('hidden');
            
            const key = `${grade}-${level}`;
            try {
                let data;
                if (gradePromises[key]) {
                    data = await gradePromises[key];
                } else {
                    const response = await fetch(`${API_URL}?action=getStudents&grade=${encodeURIComponent(grade)}&level=${encodeURIComponent(level)}&t=${new Date().getTime()}`, { redirect: 'follow' });
                    data = await response.json();
                }
                loader.classList.add('hidden');
                renderStudentList(data, listContainer, level);
            } catch (error) {
                loader.classList.add('hidden');
                listContainer.innerHTML = `<div class="text-red-500 text-center">Error de conexión.</div>`;
            }
        }

        function renderStudentList(data, container, level) {
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-400">Sin registros</div>`;
                return;
            }

            const hoverClass = level === 'Primaria' ? 'hover:border-montessori-red' : 'hover:border-montessori-blue';
            const btnClass = level === 'Primaria' 
                ? 'text-montessori-red border-montessori-red hover:bg-montessori-red' 
                : 'text-montessori-blue border-montessori-blue hover:bg-montessori-blue';

            container.innerHTML = data.map((student, index) => `
                <div class="flex items-center justify-between p-4 bg-white border border-gray-100 rounded-lg ${hoverClass} hover:shadow-sm transition-all fade-in">
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-gray-400 w-6 text-right">${index + 1}.</span>
                        <span class="font-semibold text-gray-700">${student.nombre}</span>
                    </div>
                    <a href="${student.link}" target="_blank" class="text-sm font-bold ${btnClass} px-4 py-2 rounded-lg hover:text-white border transition-all">
                        Boletín
                    </a>
                </div>
            `).join('');
        }

        // --- LÓGICA DEL FONDO ACADÉMICO ---
        // Se eliminó la lógica de generación de partículas por mouse
        const symbols = ['100', 'A+', 'A', '10', '✓', '95', 'B+', '★', '90', 'A', '100'];

        function initAllParticles() {
            const containers = document.querySelectorAll('.particles-container');
            containers.forEach(container => createParticlesForContainer(container));
        }

        function createParticlesForContainer(container) {
            const particleCount = 18; // Densidad por pantalla
            
            for (let i = 0; i < particleCount; i++) {
                spawnParticle(container);
            }
        }

        function spawnParticle(container) {
            const span = document.createElement('span');
            span.textContent = symbols[Math.floor(Math.random() * symbols.length)];
            span.classList.add('grade-particle');
            
            // Color aleatorio (Azul o Rojo)
            if (Math.random() > 0.5) span.classList.add('blue');
            else span.classList.add('red');

            const rotation = Math.floor(Math.random() * 40 - 20);
            span.style.setProperty('--rotation', `${rotation}deg`);

            // Partícula de fondo
            span.classList.add('background');
            const left = Math.random() * 100;
            const duration = 15 + Math.random() * 20; 
            const delay = Math.random() * -30; 
            const size = 0.8 + Math.random() * 1.2; 

            span.style.left = `${left}%`;
            span.style.animationDuration = `${duration}s`;
            span.style.animationDelay = `${delay}s`;
            span.style.fontSize = `${size}rem`;

            container.appendChild(span);
        }
    </script>
</body>
</html>
