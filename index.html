<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Notas - Pinceladas Montessori</title>
    
    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect x=%2210%22 y=%2240%22 width=%2220%22 height=%2250%22 rx=%224%22 fill=%22%23002060%22/><rect x=%2240%22 y=%2225%22 width=%2220%22 height=%2265%22 rx=%224%22 fill=%22%23002060%22/><rect x=%2270%22 y=%2210%22 width=%2220%22 height=%2280%22 rx=%224%22 fill=%22%23C00000%22/></svg>">

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Chewy&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        montserrat: ['Montserrat', 'sans-serif'],
                        chewy: ['Chewy', 'cursive']
                    },
                    colors: {
                        montessori: {
                            blue: '#002060',  /* Azul Oficial Unificado */
                            red: '#C00000',   /* Rojo Oficial Unificado */
                            yellow: '#FFD966',
                            gray: '#F3F4F6'
                        },
                        logo: {
                            blue: '#002060',
                            red: '#C00000'
                        }
                    },
                    animation: {
                        'blob': 'blob 15s infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '25%': { transform: 'translate(150px, -180px) scale(1.4) rotate(45deg)' },
                            '50%': { transform: 'translate(-100px, 120px) scale(0.8) rotate(-30deg)' },
                            '75%': { transform: 'translate(50px, -50px) scale(1.1) rotate(15deg)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* --- CORE LAYOUT --- */
        body { 
            background-color: #F8FAFC; 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        
        main {
            flex: 1;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            padding: 1rem; 
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- ANIMACIÓN DEL BANNER INFINITO (Seamless) --- */
        .marquee-wrapper {
            display: flex;
            overflow: hidden;
            user-select: none;
            mask-image: linear-gradient(to right, transparent 0%, black 0%, black 95%, transparent 100%);
            align-items: center; /* Asegura centrado vertical del contenedor padre */
        }

        .marquee-content {
            flex-shrink: 0;
            display: flex;
            align-items: center; /* Asegura centrado vertical de los items */
            justify-content: space-around;
            min-width: 100%;
            gap: 0; 
            animation: scroll-seamless 40s linear infinite; 
            height: 100%; /* Ocupa toda la altura para centrar bien */
        }

        @keyframes scroll-seamless {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }

        /* --- ANIMACIÓN COLOR PULSE --- */
        @keyframes colorPulse { 
            0% { color: #9CA3AF; } 
            25% { color: #C00000; } 
            50% { color: #9CA3AF; } 
            75% { color: #002060; } 
            100% { color: #9CA3AF; } 
        }
        .animate-pulse-color { animation: colorPulse 8s ease-in-out infinite; }

        /* --- LOADER --- */
        .loader {
            border: 3px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top: 3px solid #ffffff;
            width: 20px; 
            height: 20px; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Transiciones */
        .fade-out { animation: fadeOut 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeOut { from { opacity: 1; filter: blur(0); } to { opacity: 0; filter: blur(2px); pointer-events: none; } }
        @keyframes fadeIn { from { opacity: 0; filter: blur(4px); } to { opacity: 1; filter: blur(0); } }

        /* --- ESTILOS DEL LOGO (Variables Unificadas) --- */
        :root { --logo-blue: #002060; --logo-red: #C00000; }
        
        .text-colegio {
            color: var(--logo-blue);
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: -0.1em;
            line-height: 1;
        }
        .text-pinceladas {
            font-family: 'Chewy', cursive;
            color: var(--logo-red);
            line-height: 1;
        }
        .text-montessori-sub {
            background-color: var(--logo-blue);
            color: #ffffff;
            padding: 0.1em 0.3em;
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: -0.1em;
            letter-spacing: 0.1em;
            text-align: center;
            width: auto; 
        }
        
        .logo-lg .text-colegio { font-size: clamp(1.2rem, 3vw, 1.5rem); }
        .logo-lg .text-pinceladas { font-size: clamp(3rem, 8vw, 4rem); }
        .logo-lg .text-montessori-sub { font-size: clamp(1.2rem, 3vw, 1.5rem); }

        .logo-sm .text-colegio { font-size: 0.55rem; }
        .logo-sm .text-pinceladas { font-size: 1.3rem; }
        .logo-sm .text-montessori-sub { font-size: 0.55rem; padding: 1px 4px; }
        
        .group-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%; 
            padding: 1rem; 
        }
    </style>
</head>
<body class="text-slate-800 font-sans">

    <!-- ================================ -->
    <!-- PANTALLA DE LOGIN -->
    <!-- ================================ -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-50 overflow-hidden transition-all duration-700">
        
        <!-- Fondo animado -->
        <div class="absolute inset-0 w-full h-full bg-white overflow-hidden">
            <div class="absolute top-[-10%] left-[-10%] w-[45rem] h-[45rem] bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[0ms]"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[38rem] h-[38rem] bg-red-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[3000ms]"></div>
            <div class="absolute top-[30%] left-[30%] w-[32rem] h-[32rem] bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-60 animate-blob animation-delay-[6000ms]"></div>
        </div>

        <!-- Contenedor de la frase inspiradora (Oculto inicialmente) -->
        <div id="quote-container" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center p-8 text-center max-w-4xl mx-auto">
            <h2 id="quote-text" class="text-3xl md:text-5xl font-bold text-montessori-blue leading-tight font-montessori drop-shadow-sm mb-4 animate-pulse">
                <!-- Frase inyectada por JS -->
            </h2>
            <div class="h-1 w-24 bg-montessori-red rounded-full mx-auto"></div>
        </div>

        <!-- Tarjeta de Login con Altura Fija -->
        <div id="login-card" class="relative z-10 w-full max-w-md mx-4 transition-all duration-700">
            <div class="bg-white/80 backdrop-blur-xl border border-white/50 rounded-3xl shadow-2xl p-8 md:p-10 flex flex-col items-center justify-center min-h-[580px]">
                <div class="logo-container logo-lg cursor-default text-center mb-8">
                    <div class="text-section flex flex-col items-center">
                        <div class="text-colegio">COLEGIO</div>
                        <div class="text-pinceladas">Pinceladas</div>
                        <div class="text-montessori-sub">MONTESSORI</div>
                    </div>
                </div>

                <div class="w-full">
                    <form id="login-form" onsubmit="handleLogin(event)" class="space-y-5" autocomplete="off">
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400 group-focus-within:text-montessori-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            </div>
                            <input type="password" id="username" required class="w-full pl-12 pr-4 py-3 rounded-xl bg-gray-50/50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-300 font-medium text-sm placeholder-gray-400" placeholder="Usuario" autocomplete="new-password">
                        </div>
                        <div class="relative group">
                             <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400 group-focus-within:text-montessori-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            </div>
                            <input type="password" id="password" required class="w-full pl-12 pr-4 py-3 rounded-xl bg-gray-50/50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-300 font-medium text-sm placeholder-gray-400" placeholder="Contraseña" autocomplete="new-password">
                        </div>
                        
                        <!-- ÁREA DE MENSAJES DE ESTADO (FEEDBACK) -->
                        <div id="login-status-container" class="h-12 transition-all duration-300 p-3 rounded-lg flex items-center justify-center gap-2 opacity-0 pointer-events-none">
                            <!-- Icono dinámico -->
                            <svg id="login-status-icon" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <!-- Texto dinámico -->
                            <span id="login-status-text" class="text-xs font-bold"></span>
                        </div>
                        
                        <!-- BOTÓN DE LOGIN -->
                        <button type="submit" id="btn-login" class="relative w-full bg-montessori-blue text-white font-bold text-base py-3.5 rounded-xl shadow-lg shadow-montessori-blue/30 hover:bg-montessori-blue hover:shadow-montessori-blue/50 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 flex justify-center items-center">
                            <span id="btn-text">Acceder</span>
                            <div id="btn-loader" class="loader hidden absolute"></div>
                        </button>
                        
                    </form>
                    <div class="mt-6 text-center border-t border-gray-100 pt-4">
                        <a href="https://mail.google.com/mail/?view=cm&fs=1&to=gestion.educativa.pinceladas@gmail.com" target="_blank" class="text-xs text-gray-400 hover:text-montessori-blue transition-colors font-medium flex items-center justify-center gap-1">
                            Soporte Técnico
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================ -->
    <!-- PANTALLA DE TIMEOUT (INACTIVIDAD) -->
    <!-- ================================ -->
    <div id="timeout-screen" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-white/90 backdrop-blur-sm transition-opacity duration-500">
        <div class="bg-white p-8 rounded-3xl shadow-2xl border border-gray-100 max-w-sm w-full text-center transform scale-100 transition-transform mx-4">
            <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6 ring-4 ring-red-50/50">
                <svg class="w-10 h-10 text-montessori-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Sesión Expirada</h3>
            <p class="text-gray-500 text-sm mb-8 leading-relaxed">Por motivos de seguridad, tu sesión se ha cerrado automáticamente debido a inactividad.</p>
            <button onclick="location.reload()" class="w-full bg-montessori-blue text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-blue-800 hover:shadow-montessori-blue/30 transition-all duration-300 transform hover:-translate-y-0.5 active:translate-y-0">
                Volver a Acceder
            </button>
        </div>
    </div>

    <!-- ================================ -->
    <!-- MODAL ACCESO DENEGADO (POP-UP) -->
    <!-- ================================ -->
    <div id="access-denied-modal" class="hidden fixed inset-0 z-[210] flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300 border border-gray-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-50 mb-4 animate-pulse">
                    <svg class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h3 class="text-xl leading-6 font-bold text-gray-900 mb-2" id="modal-title">Acceso Restringido</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500 mb-6">No tienes permisos suficientes para ver el contenido de este grado.</p>
                </div>
                <div class="mt-2">
                    <button type="button" onclick="closeAccessDenied()" class="w-full inline-flex justify-center items-center rounded-xl border border-transparent shadow-md px-4 py-3 bg-gray-800 text-base font-bold text-white hover:bg-gray-700 focus:outline-none transition-all transform hover:-translate-y-0.5">
                        Entendido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================ -->
    <!-- APLICACIÓN PRINCIPAL -->
    <!-- ================================ -->
    <div id="app-content" class="hidden flex-col h-full w-full bg-white opacity-0 transition-opacity duration-1000">
        
        <!-- HEADER -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm h-14 flex-shrink-0 w-full">
            <div class="w-full px-4 h-full flex justify-between items-center">
                <div class="logo-container logo-sm cursor-pointer hover:opacity-90 transition-opacity" onclick="showHome()">
                    <div class="text-section flex flex-col items-center">
                        <div class="text-colegio">COLEGIO</div>
                        <div class="text-pinceladas">Pinceladas</div>
                        <div class="text-montessori-sub">MONTESSORI</div>
                    </div>
                </div>
                <!-- HEADER PERSONALIZADO -->
                <div class="flex items-center">
                    <div class="text-right flex flex-col justify-center h-full items-end"> 
                        <!-- Nombre dinámico (se rellena con JS) -->
                        <p id="user-name-display" class="text-sm font-black text-montessori-blue leading-none mb-1 tracking-wide uppercase">...</p>
                        <button onclick="logout()" class="text-[10px] text-red-500 font-bold hover:bg-red-50 rounded px-2 py-0.5 transition-colors uppercase tracking-wide border border-transparent hover:border-red-100 leading-none flex items-center gap-1">
                            <span>Cerrar Sesión</span>
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 w-full max-w-6xl mx-auto px-4 py-4 no-scrollbar overflow-y-auto">
            
            <!-- DASHBOARD METRICS -->
            <div id="dashboard-metrics" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 fade-in">
                
                <!-- CARD 1: Periodo -->
                <div class="relative overflow-hidden bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:shadow-lg hover:shadow-montessori-blue/10 hover:border-blue-100 transition-all duration-300 group cursor-default">
                    <div class="absolute -top-6 -right-6 w-24 h-24 bg-blue-50 rounded-full opacity-50 blur-2xl group-hover:bg-blue-100 transition-colors duration-500"></div>
                    <div class="relative flex items-center gap-4">
                        <div class="flex-shrink-0 h-12 w-12 rounded-2xl bg-blue-50 text-montessori-blue flex items-center justify-center shadow-sm group-hover:scale-105 transition-transform duration-300">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                        <div class="flex flex-col">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">Periodo</p>
                            <p class="text-lg font-black text-gray-800 leading-none">2025 - 2026</p>
                        </div>
                    </div>
                </div>

                <!-- CARD 2: Estado -->
                <div class="relative overflow-hidden bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:shadow-lg hover:shadow-green-500/10 hover:border-green-100 transition-all duration-300 group cursor-default">
                    <div class="absolute -top-6 -right-6 w-24 h-24 bg-green-50 rounded-full opacity-50 blur-2xl group-hover:bg-green-100 transition-colors duration-500"></div>
                    <div class="relative flex items-center gap-4">
                        <div id="status-icon-bg" class="flex-shrink-0 h-12 w-12 rounded-2xl bg-gray-100 text-gray-400 flex items-center justify-center shadow-sm transition-colors duration-300 group-hover:scale-105">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <div class="flex flex-col">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">Estado</p>
                            <div id="status-text-container" class="flex items-center gap-2">
                                <span id="status-dot" class="w-2.5 h-2.5 rounded-full bg-gray-400 animate-pulse shadow-sm"></span> 
                                <span id="status-label" class="text-lg font-black text-gray-600 leading-none">...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CARD 3: USUARIOS ONLINE (NUEVO - REALTIME) -->
                <div class="relative overflow-hidden bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:shadow-lg hover:shadow-purple-500/10 hover:border-purple-100 transition-all duration-300 group cursor-default">
                     <div class="absolute -top-6 -right-6 w-24 h-24 bg-purple-50 rounded-full opacity-50 blur-2xl group-hover:bg-purple-100 transition-colors duration-500"></div>
                    
                    <div class="relative flex items-center gap-4">
                        <div class="flex-shrink-0 h-12 w-12 rounded-2xl bg-purple-50 text-purple-600 flex items-center justify-center shadow-sm group-hover:scale-105 transition-transform duration-300">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        </div>
                        <div class="flex flex-col">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">Usuarios Online</p>
                            <div class="flex items-center gap-2">
                                <span id="live-users-dot" class="w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse shadow-sm"></span>
                                <p id="live-users-count" class="text-lg font-black text-gray-800 leading-none">1</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- VISTA HOME (Grados) -->
            <div id="view-home" class="fade-in h-full flex flex-col pb-8">
                
                <!-- Primaria -->
                <div class="flex items-center gap-2 mb-3 border-b border-gray-100 pb-1">
                    <div class="h-5 w-1 bg-montessori-red rounded-full"></div>
                    <h2 class="text-lg font-bold text-montessori-red">Nivel Primaria</h2>
                </div>
                <div id="grid-primaria" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-6"></div>

                <!-- Secundaria -->
                <div class="flex items-center gap-2 mb-3 border-b border-gray-100 pb-1">
                    <div class="h-5 w-1 bg-montessori-blue rounded-full"></div>
                    <h2 class="text-lg font-bold text-montessori-blue">Nivel Secundaria</h2>
                </div>
                <div id="grid-secundaria" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>

                <!-- BANNER DE ANUNCIOS -->
                <div id="announcement-banner" class="hidden mt-6 rounded-xl overflow-hidden shadow-sm border border-montessori-red fade-in relative bg-white max-w-full mx-auto">
                    <div class="flex items-center relative h-12">
                        <div class="absolute left-0 top-0 h-full z-20 bg-white pr-4 pl-4 flex items-center gap-2 border-r border-montessori-red shadow-[2px_0_5px_rgba(0,0,0,0.05)]">
                            <div class="bg-montessori-red/10 p-1.5 rounded-full animate-pulse">
                                <svg class="w-4 h-4 text-montessori-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                                </svg>
                            </div>
                            <span class="text-xs font-bold tracking-widest uppercase text-montessori-red">Avisos</span>
                        </div>
                        <div class="marquee-wrapper w-full h-full pl-[110px]"> 
                            <div id="marquee-track" class="marquee-content font-bold text-sm text-montessori-blue"></div>
                            <div id="marquee-track-clone" class="marquee-content font-bold text-sm text-montessori-blue" aria-hidden="true"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA ESTUDIANTES -->
            <div id="view-students" class="hidden fade-in w-full">
                <div class="flex items-center gap-2 mb-4 text-sm text-gray-500">
                    <button onclick="showHome()" class="hover:text-montessori-blue hover:underline flex items-center gap-1 font-medium transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        Volver a Grados
                    </button>
                    <span>/</span>
                    <span id="current-grade-title" class="font-bold text-montessori-blue">...</span>
                </div>
                <div class="w-full max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-4 px-4">
                        <h3 class="font-bold text-gray-700 text-lg">Listado Oficial</h3>
                        <div id="loading-indicator" class="hidden flex items-center gap-2 text-montessori-blue">
                             <div class="loader" style="width: 16px; height: 16px; border-width: 2px; border-color: #E5E7EB; border-top-color: #002060;"></div>
                             <span class="text-xs font-medium">Actualizando...</span>
                        </div>
                    </div>
                    <div id="students-list-container" class="space-y-2"></div>
                </div>
            </div>
        </main>

        <footer class="bg-white border-t border-gray-200 py-4 mt-auto flex-shrink-0 w-full z-10">
            <div class="text-center text-[10px] sm:text-xs">
                <a href="https://chrisjocoes21.github.io/PORTAFOLIO/" target="_blank" class="animate-pulse-color font-medium transition-colors hover:underline" title="Visitar Portafolio">
                    © 2025 Sistema de Calificaciones - Desarrollado por Didac-Click Group.
                </a>
            </div>
        </footer>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwnNusWP5LlxipynwTszW7bz70GNZa4n3RfEm-8tsM7nFktVeNvXATqz8HddKY_2YK9/exec"; 
        
        // Variables DOM
        const loginScreen = document.getElementById('login-screen');
        const loginCard = document.getElementById('login-card');
        const quoteContainer = document.getElementById('quote-container');
        const quoteText = document.getElementById('quote-text');
        const appContent = document.getElementById('app-content');
        const userNameDisplay = document.getElementById('user-name-display');
        const loginStatusContainer = document.getElementById('login-status-container');
        const loginStatusText = document.getElementById('login-status-text');
        const btnLogin = document.getElementById('btn-login');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const timeoutScreen = document.getElementById('timeout-screen');
        const accessDeniedModal = document.getElementById('access-denied-modal');

        const quotes = [
            "Lo más importante es que lo más importante sea lo más importante.",
            "Empieza cada día con un fin en mente.",
            "Busca primero entender, para luego ser entendido.",
            "La mejor forma de predecir tu futuro es creándolo.",
            "Sinergiza: El todo es más grande que la suma de sus partes.",
            "Sé proactivo: Tú eres el arquitecto de tu destino.",
            "Afila la sierra: Nunca dejes de aprender y crecer."
        ];

        const gradePromises = {}; 
        let inactivityTimer;
        let currentUserTimeoutMs = 1.5 * 60 * 1000; 
        let statusInterval; // Para el ciclo de actualización de usuarios

        const matchWidths = () => {
            try {
                document.querySelectorAll('.logo-container').forEach(container => {
                    const pinceladas = container.querySelector('.text-pinceladas');
                    const montessori = container.querySelector('.text-montessori-sub');
                    if (pinceladas && montessori) {
                        montessori.style.width = `${pinceladas.offsetWidth}px`;
                    }
                });
            } catch (error) { console.error(error); }
        };
        window.addEventListener('resize', matchWidths);

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            if (loginScreen.classList.contains('hidden') && 
                timeoutScreen.classList.contains('hidden')) { 
                
                inactivityTimer = setTimeout(() => {
                    handleSessionTimeout();
                }, currentUserTimeoutMs);
            }
        }

        function handleSessionTimeout() {
            sessionStorage.removeItem('pinceladas_session');
            timeoutScreen.classList.remove('hidden');
            timeoutScreen.classList.add('fade-in');
            appContent.classList.add('blur-sm');
        }

        window.onload = () => {
            document.body.onmousemove = resetInactivityTimer;
            document.body.onkeydown = resetInactivityTimer;
            document.body.onclick = resetInactivityTimer;
            matchWidths();
            checkSessionValidity();
            // Lanzar un check inicial sin usuario para ver estado general
            checkSystemStatus(); 
        };

        function checkSessionValidity() {
            const sessionData = sessionStorage.getItem('pinceladas_session');
            if (sessionData) {
                const session = JSON.parse(sessionData);
                const sessionTimeout = session.timeout ? (session.timeout * 60 * 1000) : currentUserTimeoutMs;
                
                if ((new Date().getTime() - session.loginTime) > sessionTimeout) {
                    sessionStorage.removeItem('pinceladas_session');
                } else {
                    currentUserTimeoutMs = sessionTimeout;
                    skipIntro(session.name);
                    resetInactivityTimer();
                }
            }
        }

        function updateLoginStatus(status, message) {
            loginStatusContainer.classList.remove('opacity-0', 'opacity-100', 'bg-red-50', 'border-red-100', 'bg-green-50', 'border-green-100', 'bg-blue-50', 'border-blue-100', 'text-red-600', 'text-green-600', 'text-blue-600');
            loginStatusText.textContent = message;
            loginStatusContainer.classList.add('opacity-100', 'border');
            
            if (status === 'error') {
                loginStatusContainer.classList.add('bg-red-50', 'border-red-100', 'text-red-600');
            } else if (status === 'success') {
                loginStatusContainer.classList.add('bg-green-50', 'border-green-100', 'text-green-600');
            } else if (status === 'loading') {
                loginStatusContainer.classList.add('bg-blue-50', 'border-blue-100', 'text-blue-600');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value;
            
            updateLoginStatus('loading', 'Verificando credenciales...');
            btnText.classList.add('opacity-0');
            btnLoader.classList.remove('hidden');
            btnLogin.classList.add('cursor-not-allowed');
            btnLogin.disabled = true;

            try {
                const response = await fetch(`${API_URL}?action=login&username=${encodeURIComponent(usernameInput)}&password=${encodeURIComponent(passwordInput)}`);
                const data = await response.json();
                
                if (data.success) {
                    updateLoginStatus('success', '¡Acceso Autorizado!');
                    
                    currentUserTimeoutMs = (data.timeout || 1.5) * 60 * 1000;

                    sessionStorage.setItem('pinceladas_session', JSON.stringify({
                        auth: true,
                        name: data.name,
                        permissions: data.permissions, 
                        timeout: data.timeout,
                        loginTime: new Date().getTime()
                    }));
                    
                    prefetchGradesData();
                    checkSystemStatus(data.name); // Enviar usuario para registrar actividad
                    loadAnnouncements();

                    setTimeout(() => {
                        unlockInterface(data.name);
                    }, 800);
                } else {
                    throw new Error('Credenciales');
                }
            } catch (error) {
                updateLoginStatus('error', 'Credenciales incorrectas');
                btnText.classList.remove('opacity-0');
                btnLoader.classList.add('hidden');
                btnLogin.classList.remove('cursor-not-allowed');
                btnLogin.disabled = false;
            } finally {
                document.getElementById('password').value = '';
            }
        }

        function checkPermissions(gradeName) {
            const sessionData = sessionStorage.getItem('pinceladas_session');
            if (!sessionData) return false;
            const session = JSON.parse(sessionData);
            const userPerms = (session.permissions || "").toUpperCase().trim();
            if (userPerms === 'TODO' || userPerms === 'ADMIN') return true;
            if (userPerms.includes(gradeName.toUpperCase())) return true;
            return false;
        }

        function closeAccessDenied() {
            accessDeniedModal.classList.remove('opacity-100');
            accessDeniedModal.classList.add('opacity-0');
            setTimeout(() => {
                accessDeniedModal.classList.add('hidden');
            }, 300);
        }

        function prefetchGradesData() {
            const allGrades = [...gradosPrimaria, ...gradosSecundaria];
            allGrades.forEach(g => {
                if (checkPermissions(g.nombre)) {
                    const key = `${g.nombre}-${g.nivel}`;
                    gradePromises[key] = fetch(`${API_URL}?action=getStudents&grade=${encodeURIComponent(g.nombre)}&level=${encodeURIComponent(g.nivel)}&t=${new Date().getTime()}`)
                        .then(response => response.json())
                        .catch(error => []);
                }
            });
        }

        function skipIntro(name) {
            prefetchGradesData(); 
            loginScreen.classList.add('hidden');
            appContent.classList.remove('hidden');
            appContent.classList.add('flex', 'fade-in');
            initApp(name);
        }

        function unlockInterface(name) {
            loginCard.classList.add('fade-out');
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            quoteText.textContent = randomQuote;

            setTimeout(() => {
                loginCard.classList.add('hidden'); 
                quoteContainer.classList.remove('hidden');
                quoteContainer.classList.add('fade-in');
            }, 400);

            setTimeout(() => {
                loginScreen.classList.add('fade-out');
                setTimeout(() => {
                    loginScreen.classList.add('hidden');
                    quoteContainer.classList.add('hidden'); 
                    appContent.classList.remove('hidden');
                    appContent.classList.add('flex', 'fade-in');
                    initApp(name);
                }, 500); 
            }, 2000);
        }

        function initApp(name) {
            // Header Personalizado
            userNameDisplay.textContent = name || 'Usuario';
            
            renderGrades();
            
            // Iniciar ciclo de actualización de estado (cada 60s)
            startStatusCycle(name);
            
            loadAnnouncements();
            resetInactivityTimer(); 
            setTimeout(matchWidths, 100); 
        }
        
        function startStatusCycle(username) {
            // Primera llamada inmediata con usuario
            checkSystemStatus(username);
            
            // Limpiar intervalo anterior si existe
            if (statusInterval) clearInterval(statusInterval);
            
            // Configurar nuevo intervalo
            statusInterval = setInterval(() => {
                // Solo ejecutar si la app está visible
                if (!document.hidden) {
                    checkSystemStatus(username);
                }
            }, 60000); // Cada minuto
        }

        async function loadAnnouncements() {
            const banner = document.getElementById('announcement-banner');
            const track1 = document.getElementById('marquee-track');
            const track2 = document.getElementById('marquee-track-clone');
            
            try {
                const response = await fetch(`${API_URL}?action=getAnnouncements`);
                const announcements = await response.json();
                
                if (announcements && announcements.length > 0) {
                    const rawText = announcements.map(a => `<span>${a.mensaje}</span>`).join('<span class="mx-6 text-montessori-red/50 text-lg font-light">|</span>');
                    if(!rawText.trim()) { banner.classList.add('hidden'); return; }

                    const separator = '<span class="mx-6 text-montessori-red/50 text-lg font-light">|</span>';
                    const repeatedBlock = `${rawText} ${separator} ${rawText} ${separator} ${rawText} ${separator}`;

                    track1.innerHTML = repeatedBlock;
                    track2.innerHTML = repeatedBlock; 
                    banner.classList.remove('hidden'); 
                } else {
                    banner.classList.add('hidden'); 
                }
            } catch (e) {
                console.error("Error anuncios", e);
                banner.classList.add('hidden');
            }
        }

        function logout() {
            sessionStorage.removeItem('pinceladas_session');
            location.reload();
        }

        const gradosPrimaria = [
            { nombre: "1º Grado", nivel: "Primaria", icon: "1" },
            { nombre: "2º Grado", nivel: "Primaria", icon: "2" },
            { nombre: "3º Grado", nivel: "Primaria", icon: "3" },
            { nombre: "4º Grado", nivel: "Primaria", icon: "4" },
            { nombre: "5º Grado", nivel: "Primaria", icon: "5" },
            { nombre: "6º Grado", nivel: "Primaria", icon: "6" }
        ];

        const gradosSecundaria = [
            { nombre: "1º Grado", nivel: "Secundaria", icon: "I" },
            { nombre: "2º Grado", nivel: "Secundaria", icon: "II" },
            { nombre: "3º Grado", nivel: "Secundaria", icon: "III" }
        ];

        function renderGrades() {
            const pContainer = document.getElementById('grid-primaria');
            const sContainer = document.getElementById('grid-secundaria');
            if(!pContainer || !sContainer) return; 

            const createCard = (g, color) => `
                <div onclick="loadStudents('${g.nombre}', '${g.nivel}')" class="cursor-pointer group bg-white border-2 border-black rounded-xl group-card relative overflow-hidden transition-all duration-300 hover:shadow-xl hover:-translate-y-1 ${color === 'red' ? 'hover:shadow-montessori-red/40' : 'hover:shadow-montessori-blue/40'}">
                     <div class="flex flex-col justify-between h-full relative z-10">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-[10px] uppercase tracking-widest text-gray-400 font-bold mb-1">Grado</p>
                                <h3 class="text-xl font-bold text-gray-800">${g.nombre}</h3>
                            </div>
                            <div class="h-9 w-9 rounded-lg bg-gray-50 flex items-center justify-center text-gray-400 font-bold text-base shadow-sm transition-colors ${color === 'red' ? 'group-hover:text-montessori-red group-hover:bg-red-50' : 'group-hover:text-montessori-blue group-hover:bg-blue-50'}">
                                ${g.icon}
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100/50"></div>
                     </div>
                     <div class="absolute -bottom-6 -right-6 text-gray-50 opacity-0 group-hover:opacity-20 transform rotate-12 scale-150 pointer-events-none font-black text-6xl transition-opacity duration-300">
                        ${g.icon}
                     </div>
                </div>
            `;
            pContainer.innerHTML = gradosPrimaria.map(g => createCard(g, 'red')).join('');
            sContainer.innerHTML = gradosSecundaria.map(g => createCard(g, 'blue')).join('');
        }

        // --- ACTUALIZACIÓN DE ESTADO Y USUARIOS ONLINE ---
        async function checkSystemStatus(username = null) {
            const dot = document.getElementById('status-dot');
            const label = document.getElementById('status-label');
            const iconBg = document.getElementById('status-icon-bg');
            
            // Elementos de la tarjeta Usuarios Online
            const liveCount = document.getElementById('live-users-count');
            const liveDot = document.getElementById('live-users-dot');
            
            let url = `${API_URL}?action=checkStatus&t=${new Date().getTime()}`;
            if (username) url += `&username=${encodeURIComponent(username)}`;

            try {
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Actualizar Estado Sistema
                    if(data.status === 'online') {
                        dot.classList.remove('bg-gray-400', 'bg-red-500'); dot.classList.add('bg-green-500');
                        label.textContent = "En Línea"; label.classList.add('text-green-700');
                        iconBg.classList.remove('bg-gray-100', 'text-gray-400'); iconBg.classList.add('bg-green-50', 'text-green-600');
                    }
                    
                    // Actualizar Contador Usuarios
                    if (data.activeUsers !== undefined) {
                        liveCount.textContent = data.activeUsers;
                        
                        // Cambiar color del punto según carga
                        liveDot.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
                        if (data.activeUsers < 5) {
                            liveDot.classList.add('bg-green-500');
                        } else if (data.activeUsers < 15) {
                            liveDot.classList.add('bg-yellow-500');
                        } else {
                            liveDot.classList.add('bg-red-500');
                        }
                    }
                }
            } catch (error) { 
                dot.classList.add('bg-red-500'); label.textContent = "Offline";
            } 
        }

        function showHome() {
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('dashboard-metrics').classList.remove('hidden');
            document.getElementById('view-students').classList.add('hidden');
        }

        async function loadStudents(grade, level) {
            if (!checkPermissions(grade)) {
                accessDeniedModal.classList.remove('hidden');
                setTimeout(() => {
                    accessDeniedModal.classList.remove('opacity-0');
                    accessDeniedModal.classList.add('opacity-100');
                }, 10);
                return; 
            }

            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('dashboard-metrics').classList.add('hidden');
            document.getElementById('view-students').classList.remove('hidden');
            document.getElementById('current-grade-title').textContent = `${grade} - ${level}`;
            const listContainer = document.getElementById('students-list-container');
            const loader = document.getElementById('loading-indicator');
            listContainer.innerHTML = '';
            loader.classList.remove('hidden');
            
            const key = `${grade}-${level}`;
            try {
                let data;
                if (gradePromises[key]) {
                    data = await gradePromises[key];
                } else {
                    const response = await fetch(`${API_URL}?action=getStudents&grade=${encodeURIComponent(grade)}&level=${encodeURIComponent(level)}&t=${new Date().getTime()}`);
                    data = await response.json();
                }
                loader.classList.add('hidden');
                renderStudentList(data, listContainer);
            } catch (error) {
                loader.classList.add('hidden');
                listContainer.innerHTML = `<div class="text-red-500 text-center">Error de conexión.</div>`;
            }
        }

        function renderStudentList(data, container) {
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-400">Sin registros</div>`;
                return;
            }
            container.innerHTML = data.map((student, index) => `
                <div class="flex items-center justify-between p-4 bg-white border border-gray-100 rounded-lg hover:border-montessori-blue/30 hover:shadow-sm transition-all fade-in">
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-gray-400 w-6 text-right">${index + 1}.</span>
                        <span class="font-semibold text-gray-700">${student.nombre}</span>
                    </div>
                    <a href="${student.link}" target="_blank" class="text-sm font-bold text-montessori-blue border border-montessori-blue px-4 py-2 rounded-lg hover:bg-montessori-blue hover:text-white transition-all">
                        Boletín
                    </a>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
